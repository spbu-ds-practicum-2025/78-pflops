# План E2E тестирования Moonshine Marketplace (MVP)

## Введение

Данный документ описывает сценарии сквозного (end-to-end) тестирования MVP системы «Moonshine Marketplace».
Все тесты предназначены для ручного выполнения и фокусируются на взаимодействии с системой через UI, при необходимости — с валидацией состояния через REST API.

**Компоненты системы:**
- SPA-фронтенд: `services/frontend/index.html`
- Nginx API-gateway: `services/api-gateway/nginx.conf`
- HTTP-шлюз: `services/http_gateway`
- Go `user_service`, `ad_service` + PostgreSQL базы данных
- Python `MediaService` + MinIO для хранения изображений

**Охват MVP (что тестируется):**
- Регистрация и вход пользователя, режимы: гость / пользователь
- Просмотр списка объявлений и отдельной страницы объявления
- Работа с изображениями (загрузка, отображение нескольких картинок, переключение)
- Создание, редактирование и удаление собственных объявлений
- Профиль пользователя и список «Мои объявления»
- Поддержка прямых ссылок на объявление (deep-link)

**Предусловия для всех тестов:**
- Все сервисы системы запущены (Nginx, http_gateway, user_service, ad_service, MediaService, MinIO, frontend)
- Фронтенд доступен по адресу вида `http://localhost/` (через Nginx API-gateway)
- База может содержать несколько тестовых объявлений для сценариев поиска

---

## 1. Основная функциональность и режимы доступа

### Тест 1.1: Регистрация, вход и доступ к объявлениям

**Цель:** проверить, что после регистрации/входа пользователь получает доступ к поиску, созданию объявлений и профилю.

**Предусловия:**
- В браузере нет активного JWT в `localStorage`, то есть вход в аккаунт не выполнен.

**Шаги:**
1. Открыть главную страницу.
2. В стартовом оверлее выбрать «Зарегистрироваться».
3. Заполнить форму регистрации валидными email/паролем/именем и отправить.
4. Убедиться, что пользователь автоматически авторизован (по шапке интерфейса).
5. Проверить, что:
   - Блок входа/регистрации скрыт.
   - Секции «Создать объявление», «Поиск объявлений» и кнопка профиля видимы.

**Ожидаемый результат:**
- Появляется уведомление об успешной регистрации/авторизации.
- В шапке статус: «Авторизован», отображается имя пользователя.
- Стартовый оверлей режимов скрыт.
- Блок аутентификации не виден, доступны поиск, создание объявлений и профиль.

---

### Тест 1.2: Режим гостя — просмотр без создания и профиля

**Цель:** проверить, что гость может просматривать объявления, но не создавать и не открывать профиль.

**Предусловия:**
- В браузере нет JWT в `localStorage`.

**Шаги:**
1. Открыть главную страницу.
2. В стартовом оверлее выбрать «Войти как гость».
3. Проверить, какие секции отображаются.
4. Ввести текст в поле поиска и нажать «Найти объявления».

**Ожидаемый результат:**
- После выбора гостевого режима:
  - Секция аутентификации скрыта.
  - Секция поиска объявлений видна.
  - Секция создания объявлений скрыта.
  - Кнопка профиля скрыта.
- Поиск возвращает список объявлений (если они есть в системе); карточки отображаются.

---

## 2. Объявления: создание, просмотр, изображения

### Тест 2.1: Создание объявления с несколькими изображениями

**Цель:** проверить, что авторизованный пользователь может создать объявление с несколькими изображениями, и они корректно отображаются.

**Предусловия:**
- Пользователь авторизован (из Теста 1.1).
- Есть минимум 2 локальных файла изображений для загрузки.

**Шаги:**
1. В секции «Создать объявление» заполнить заголовок, описание, цену, категорию.
2. Выбрать 2–3 файла изображений.
3. Нажать «Опубликовать объявление».
4. Дождаться уведомления об успехе.
5. Перейти в секцию поиска, выполнить поиск так, чтобы новое объявление попало в результаты (например, по заголовку).
6. Найти карточку нового объявления в списке.

**Ожидаемый результат:**
- Объявление успешно создаётся (UI-уведомление).
- В списке объявлений:
  - На карточке отображается первая картинка.
  - При количестве > 1 на карточке виден бейдж с числом изображений.
- (Опционально) Через `GET /api/ads` новое объявление присутствует с массивом `imageUrls` длиной ≥ числу загруженных файлов.

---

### Тест 2.2: Просмотр объявления на отдельной странице и просмотр отдельных изображений

**Цель:** проверить отображение отдельной страницы объявления и возможность смотреть каждую картинку по отдельности.

**Предусловия:**
- В системе есть объявление с ≥ 2 картинками (после Теста 2.1).

**Шаги:**
1. В поиске найти объявление с несколькими картинками.
2. Нажать на карточку объявления.
3. На странице объявления (`#ad-detail-section`) обратить внимание на:
   - Большое основное изображение.
   - Ряд миниатюр всех изображений.
4. Кликнуть по разным миниатюрам.

**Ожидаемый результат:**
- Вместо общего списка открывается отдельная страница объявления.
- Основное изображение меняется при клике на соответствующую миниатюру.
- Миниатюра, соответствующая текущему основному изображению, подсвечена.
- Заголовок, цена, категория, ID и описание отображаются корректно.

---


## 3. Редактирование и удаление объявлений (права владельца)

### Тест 3.1: Редактирование собственного объявления (текст и изображения)

**Цель:** проверить обновление текстовых полей и полную замену изображений для объявления владельца.

**Предусловия:**
- Пользователь авторизован.
- У пользователя есть собственное объявление с несколькими картинками (например, из Теста 2.1).
- Есть новый набор 1–2 изображений для замены.

**Шаги:**
1. Открыть профиль (кнопка профиля в шапке).
2. В разделе «Мои объявления» кликнуть по нужному объявлению.
3. На отдельной странице объявления:
   - Нажать кнопку «Редактировать» (форма редактирования появится ниже).
   - Изменить заголовок, описание или цену на новые значения.
   - Выбрать новые изображения (1–2 файла) в блоке загрузки.
4. Нажать «Сохранить изменения».
5. Обновить страницу объявления или снова открыть его через поиск.

**Ожидаемый результат:**
- После сохранения появляется уведомление «Объявление обновлено».
- Текстовые поля (заголовок, описание, цена, категория) показывают новые значения.
- Изображения объявления заменены на новые:
  - При просмотре объявления отображаются только вновь загруженные изображения.
  - (Опционально) Через `GET /api/ads/{id}` в `imageUrls` присутствуют новые URL, старых нет.

---

### Тест 3.2: Удаление собственного объявления из страницы объявления

**Цель:** проверить корректное удаление собственного объявления и обновление списка.

**Предусловия:**
- Пользователь авторизован.
- У него есть собственное объявление, известен его ID.

**Шаги:**
1. Открыть объявление через профиль или поиск и перейти на отдельную страницу.
2. Нажать кнопку «Удалить» на странице объявления.
3. Подтвердить удаление в диалоге браузера (если появляется `confirm`).
4. После успешного уведомления:
   - Вернуться к списку объявлений (происходит автоматически).
   - Выполнить поиск по заголовку удалённого объявления.

**Ожидаемый результат:**
- Объявление больше не отображается в списке.
- В профиле пользователя в разделе «Мои объявления» удалённый элемент отсутствует.
- При попытке открыть старую прямую ссылку на это объявление (опционально) объявление недоступно.
- Через `GET /api/ads` объявление отсутствует в массиве `ads`.

---

### Тест 3.3: Запрет на создание/редактирование без авторизации

**Цель:** проверить, что без валидного токена нельзя создавать, редактировать и удалять объявления.

**Предусловия:**
- В браузере полностью очищен `localStorage` (нет JWT, то есть авторизация не выполнена).

**Шаги:**
1. Открыть главную страницу, выбрать режим «гость».
2. Убедиться, что секция создания объявлений не отображается.
3. (Опционально через инструмент API) Попробовать отправить:
   - `POST /api/ads` с телом валидного объявления, но без корректного `token` или с мусорным `token`.
4. При выборе режима "пользователь" без успешного входа попытаться нажать «Опубликовать объявление».

**Ожидаемый результат:**
- На UI создание объявлений недоступно в гостевом режиме.
- При прямом вызове API без валидного токена:
  - Ответ с HTTP 401/4xx, объявление не создаётся.
- Аналогично для `PUT /api/ads/{id}` и `DELETE /api/ads/{id}` без заголовка `Authorization`:
  - Ответ 401/403/4xx, состояние объявлений не меняется.

---

### Тест 3.4: Запрет редактирования и удаления чужих объявлений

**Цель:** проверить, что пользователь не может редактировать/удалять объявления, владельцем которых он не является.

**Предусловия:**
- Существует пользователь A с объявлением `Ad_A` (ID известен).
- Существует пользователь B с отдельным аккаунтом (другой email).

**Шаги:**
1. Авторизоваться под пользователем B.
2. Через поиск найти объявление `Ad_A`.
3. Открыть страницу объявления `Ad_A`.
4. Проверить доступные действия:
   - Кнопки «Редактировать» и «Удалить» должны отсутствовать или быть неактивны.
5. (Опционально) Отправить вручную через API запросы от имени B:
   - `PUT /api/ads/{Ad_A}` с `Authorization: Bearer <token_B>`.
   - `DELETE /api/ads/{Ad_A}` с тем же токеном.

**Ожидаемый результат:**
- На UI пользователь B не видит кнопок редактирования/удаления для чужих объявлений.
- При прямых запросах:
  - Ответ 403/401/4xx, объявление `Ad_A` не меняется и не удаляется.
- При последующей проверке через поиск/`GET /api/ads/{Ad_A}` объявление остаётся в прежнем виде.

---

## 4. Профиль и «Мои объявления»

### Тест 4.1: Просмотр и изменение профиля пользователя

**Цель:** проверить отображение данных профиля и изменение имени пользователя.

**Предусловия:**
- Пользователь авторизован.

**Шаги:**
1. Нажать кнопку профиля в шапке.
2. В окне профиля убедиться, что отображаются имя и email.
3. Изменить имя в поле «Имя» на новое значение.
4. Нажать «Сохранить профиль».
5. Закрыть окно и обновить страницу.

**Ожидаемый результат:**
- В окне профиля отображается актуальное имя и email.
- После сохранения появляется уведомление «Профиль обновлён».
- При следующем открытии профиля и в шапке отображается новое имя.
- (Опционально) Через `GET /api/users/me` поле `name` возвращает новое значение.

---

### Тест 4.2: Список «Мои объявления» и переход к редактированию

**Цель:** убедиться, что профиль показывает только объявления текущего пользователя и что из него корректно открывается страница объявления.

**Предусловия:**
- Пользователь авторизован.
- У него есть не менее 2 собственных объявлений.

**Шаги:**
1. Открыть профиль.
2. В разделе «Мои объявления» посчитать количество карточек и свериться с числом ожидаемых объявлений.
3. Кликнуть по одной из карточек.

**Ожидаемый результат:**
- Количество карточек «Мои объявления» совпадает с числом объявлений пользователя.
- При клике по карточке:
  - Окно профиля закрывается.
  - Открывается отдельная страница выбранного объявления.
- На странице объявления отображаются кнопки «Редактировать» и «Удалить», так как это объявления владельца.

---

## 5. Консистентность данных и комплексный сценарий

### Тест 5.1: Консистентность URL изображений объявлений

**Цель:** проверить, что ссылки на изображения из объявлений корректно ведут на MinIO через `/media/` и соответствуют тому, что видит пользователь.

**Предусловия:**
- Есть объявление с несколькими изображениями.

**Шаги:**
1. Через API `GET /api/ads/{id}` получить объявление и список `imageUrls`.
2. На UI открыть это объявление на отдельной странице.
3. Сравнить адреса картинок на UI (атрибуты `src` у `<img>`) с полученными `imageUrls`.
4. В отдельной вкладке браузера вручную открыть один из URL `/media/...`.

**Ожидаемый результат:**
- В JSON-ответе `imageUrls` совпадают с `src` атрибутами изображений на UI.
- Каждая ссылка `/media/...` успешно открывается в браузере и показывает корректное изображение.
- После редактирования объявления с заменой изображений в `imageUrls` и на UI присутствуют только новые URL.

---

### Тест 5.2: Полный сквозной сценарий пользователя

**Цель:** продемонстрировать полный жизненный цикл работы с сервисом одним пользователем.

**Предусловия:**
- Система запущена, в браузере нет JWT в `localStorage`.

**Шаги:**
1. Зарегистрироваться как новый пользователь (Тест 1.1).
2. Войти (если не вошли автоматически).
3. Создать объявление с несколькими изображениями (Тест 2.1).
4. Найти и открыть созданное объявление в отдельной странице (Тест 2.2).
5. Отредактировать объявление (изменить текст и заменить изображения) (Тест 3.1).
6. Проверить, что изменения видны в списке и на отдельной странице.
7. Открыть профиль, проверить, что объявление есть в «Мои объявления» (Тест 4.2).
8. Удалить объявление со страницы объявления (Тест 3.2).
9. Проверить, что:
   - В списке объявлений оно исчезло.
   - В профиле в «Мои объявления» его нет.
   - При попытке открыть старую прямую ссылку объявление недоступно.

**Ожидаемый результат:**
- Все шаги выполняются успешно.
- Состояние системы согласовано: объявления и профиль везде отражают одно и то же состояние.
- Пользовательский сценарий «зарегистрировался → создал → отредактировал → удалил объявление» полностью поддерживается.
